using System;
using UnityEngine;
using DG.Tweening;
using UnityEngine.UI;

namespace _Project.Develop.Runtime.UI.Core
{
    public abstract class PopupViewBase : MonoBehaviour, IShowableView
    {
        public event Action CloseRequest;

        [SerializeField] private CanvasGroup _mainGroup;
        [SerializeField] private Image _anticlicker;
        [SerializeField] private CanvasGroup _body;

        [SerializeField] private PopupAnimationTypes _animationTypes;

        private float _anticlickerDefaultAlpha;

        private Tween _currentAnimation;

        private void Awake()
        {
            _mainGroup.alpha = 0;
            _anticlickerDefaultAlpha = _anticlicker.color.a;
        }

        private void OnDestroy() => KillCurrentAnimation();

        public void OnCloseButtonClicked() => CloseRequest?.Invoke();

        public Tween Show()
        {
            KillCurrentAnimation();

            OnPreShow();

            _mainGroup.alpha = 1;

            Sequence animation =
                PopupAnimationsCreator.CreateShowAnimation(_body, _anticlicker, _animationTypes,
                    _anticlickerDefaultAlpha);

            ModifyShowAnimation(animation);
            
            animation.OnComplete(OnPostShow);

            return _currentAnimation = animation.SetUpdate(true).Play();
        }

        public Tween Hide()
        {
            KillCurrentAnimation();

            OnPreHide();

            Sequence animation = PopupAnimationsCreator.CreateHideAnimation(_body, _anticlicker, _animationTypes,
                _anticlickerDefaultAlpha);
            
            ModifyShowAnimation(animation);
            
            animation.OnComplete(OnPostHide);

            return _currentAnimation = animation.SetUpdate(true).Play();
        }

        protected virtual void ModifyShowAnimation(Sequence animation)
        {
            
        }
        
        protected virtual void ModifyHideAnimation(Sequence animation)
        {
            
        }

        protected virtual void OnPreShow()
        {
        }

        protected virtual void OnPostShow()
        {
        }

        protected virtual void OnPreHide()
        {
        }

        protected virtual void OnPostHide()
        {
        }


        private void KillCurrentAnimation()
        {
            if (_currentAnimation != null)
                _currentAnimation.Kill();
        }
    }
}